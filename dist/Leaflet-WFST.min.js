/*! Leaflet-WFST 1.0.0 2015-09-04 */
!function(a,b,c){"use strict";L.XmlUtil={namespaces:{xlink:"http://www.w3.org/1999/xlink",xmlns:"http://www.w3.org/2000/xmlns/",xsd:"http://www.w3.org/2001/XMLSchema",xsi:"http://www.w3.org/2001/XMLSchema-instance",wfs:"http://www.opengis.net/wfs",gml:"http://www.opengis.net/gml",ogc:"http://www.opengis.net/ogc",ows:"http://www.opengis.net/ows"},xmldoc:(new DOMParser).parseFromString("<root />","text/xml"),setAttributes:function(a,b){for(var c in b)if(null!=b[c]&&b[c].toString){var d=b[c].toString(),e=this.namespaces[c.substring(0,c.indexOf(":"))]||null;a.setAttributeNS(e,c,d)}},evaluate:function(a,b){var c=new DOMParser,d=c.parseFromString(b,"text/xml"),e=new XPathEvaluator,f=e.createNSResolver(d.documentElement);return e.evaluate(a,d,f,XPathResult.ANY_TYPE,null)},createElementNS:function(a,b,c){c=c||{};var d=c.uri;d||(d=this.namespaces[a.substring(0,a.indexOf(":"))]),d||(d=this.namespaces[c.prefix]);var e=d?this.xmldoc.createElementNS(d,a):this.xmldoc.createElement(a);return b&&this.setAttributes(e,b),null!=c.value&&e.appendChild(this.xmldoc.createTextNode(c.value)),e},createTextNode:function(a){return this.xmldoc.createTextNode(a)},serializeXmlDocumentString:function(a){var c=b.implementation.createDocument("","",null);c.appendChild(a);var d=new XMLSerializer;return d.serializeToString(c)},serializeXmlToString:function(a){var b=new XMLSerializer;return b.serializeToString(a)},parseXml:function(b){if("undefined"!=typeof a.DOMParser)return(new a.DOMParser).parseFromString(b,"text/xml");if("undefined"!=typeof a.ActiveXObject&&new a.ActiveXObject("Microsoft.XMLDOM")){var c=new a.ActiveXObject("Microsoft.XMLDOM");return c.async="false",c.loadXML(b),c}throw new Error("No XML parser found")}},L.Util.request=function(b){b=L.extend({async:!0,method:"POST",data:"",params:{},headers:{},url:a.location.href,success:function(a){console.log(a)},error:function(a){console.log("Ajax request fail"),console.log(a)},complete:function(){}},b);var c=new XMLHttpRequest;c.onreadystatechange=function(){4===c.readyState&&(200===c.status?b.success(c.responseText):b.error(c.responseText),b.complete())};var d=b.url+L.Util.getParamString(b.params,b.url);c.open(b.method,d,b.async);for(var e in b.headers)c.setRequestHeader(e,b.headers[e]);c.send(b.data)},L.Filter=L.Class.extend({initialize:function(){this.filter=L.XmlUtil.createElementNS("ogc:Filter")},toGml:function(){return this.filter},append:function(){return this}}),L.Filter.GmlObjectID=L.Filter.extend({append:function(a){return this.filter.appendChild(L.XmlUtil.createElementNS("ogc:GmlObjectId",{"gml:id":a})),this}}),L.Format={},L.Format.Scheme=L.Class.extend({initialize:function(a){this.geometryField=a},parse:function(a){for(var c=new L.GML.FeatureType,d=a.getElementsByTagNameNS(L.XmlUtil.namespaces.xsd,"complexType")[0],e=d.getElementsByTagNameNS(L.XmlUtil.namespaces.xsd,"sequence")[0],f=0;f<e.childNodes.length;f++){var g=e.childNodes[f];if(g.nodeType===b.ELEMENT_NODE){var h=g.attributes.name;if(h){var i=g.attributes.name.value;if(i!==this.geometryField){var j=g.attributes.type;if(!j){var k=g.getElementsByTagNameNS(L.XmlUtil.namespaces.xsd,"restriction");j=k.attributes.base}if(j){var l=j.value.split(":").pop();c.appendField(i,l)}}}}}return c}}),L.Format.Base=L.Class.extend({defaultOptions:{crs:L.CRS.EPSG3857,coordsToLatLng:function(a){return new L.LatLng(a[1],a[0],a[2])},latLngToCoords:function(a){var b=[a.lng,a.lat];return a.alt!==c&&b.push(a.alt),b},geometryField:"Shape"},initialize:function(a){if(L.setOptions(this,L.extend({},this.defaultOptions,a)),a.crs){var b=a.crs;this.options.coordsToLatLng=function(a){var c=L.point(a[0],a[1]),d=b.projection.unproject(c);return a[2]&&(d.alt=a[2]),d},this.options.latLngToCoords=function(a){var c=L.latLng(a);return b.projection.project(c)}}},setFeatureDescription:function(a){this.namespaceUri=a.attributes.targetNamespace.value;var b=new L.Format.Scheme(this.options.geometryField);this.featureType=b.parse(a)},layerEvents:function(a){var b=function(b){b=L.extend({layer:a,target:b.target},b),a.fire(b.type,b)};(a instanceof L.MultiPolygon||a instanceof L.MultiPolyline)&&a.eachLayer(function(a){a.off(L.FeatureGroup.EVENTS),a.on(L.FeatureGroup.EVENTS,b,this)})}}),L.Format.GeoJSON=L.Format.Base.extend({initialize:function(a){L.Format.Base.prototype.initialize.call(this,a),this.outputFormat="application/json"},responseToLayers:function(a){for(var b=[],c=JSON.parse(a),d=0;d<c.features.length;d++)b.push(this.processFeature(c.features[d]));return b},processFeature:function(a){var b=this.generateLayer(a);return this.layerEvents(b),b.feature=a,b},generateLayer:function(a){return L.GeoJSON.geometryToLayer(a,this.options.pointToLayer||null,this.options.coordsToLatLng||null,null)}}),L.GML=L.GML||{},L.GML.ParserContainerMixin={parsers:{},initializeParserContainer:function(){this.parsers={}},appendParser:function(a){this.parsers[a.elementTag]=a},parseElement:function(a,b){var c=this.parsers[a.tagName];if(!c)throw"unknown child element "+a.tagName;return c.parse(a,b)}},L.GML.Element=L.Class.extend({elementTag:"",parse:function(){throw"not implemented parse function in parser for "+this.elementTag}}),L.GML.Geometry=L.GML.Element.extend({statics:{DIM:2},dimensions:function(a){return a.attributes.srsDimension?parseInt(a.attributes.srsDimension.value):L.GML.Geometry.DIM}}),L.GML.Coordinates=L.GML.Element.extend({defaultSeparator:{ds:".",cs:",",ts:" "},initialize:function(){this.elementTag="gml:coordinates"},parse:function(a){var b=this.defaultSeparator.ds;a.attributes.decimal&&(b=a.attributes.decimal.value);var c=this.defaultSeparator.cs;a.attributes.cs&&(c=a.attributes.cs.value);var d=this.defaultSeparator.ts;a.attributes.ts&&(d=a.attributes.ts.value);for(var e=[],f=a.textContent.split(d),g=function(a){return"."!==b&&(a=a.replace(b,".")),parseFloat(a)},h=0;h<f.length;h++)e.push(f[h].split(c).map(g));return 1===e.length?e[0]:e}}),L.GML.Pos=L.GML.Element.extend({initialize:function(){this.elementTag="gml:pos"},parse:function(a){return a.textContent.split(" ").map(function(a){return parseFloat(a)})}}),L.GML.PosList=L.GML.Element.extend({initialize:function(){this.elementTag="gml:posList"},parse:function(a,b){for(var c=[],d=b.dimensions,e=a.textContent.split(" "),f=0;f<e.length;f+=d){for(var g=[],h=f;f+d>h;h++)g.push(parseFloat(e[h]));c.push(g)}return c}}),L.GML.PointNode=L.GML.Geometry.extend({includes:L.GML.ParserContainerMixin,initialize:function(){this.elementTag="gml:Point",this.initializeParserContainer(),this.appendParser(new L.GML.Pos),this.appendParser(new L.GML.Coordinates)},parse:function(a){return this.parseElement(a.firstChild,{dimensions:this.dimensions(a)})}}),L.GML.PointSequence=L.GML.Geometry.extend({includes:L.GML.ParserContainerMixin,initialize:function(){this.initializeParserContainer(),this.appendParser(new L.GML.Pos),this.appendParser(new L.GML.PosList),this.appendParser(new L.GML.Coordinates),this.appendParser(new L.GML.PointNode)},parse:function(a){var b=a.firstChild,c=[],d=b.tagName;if("gml:pos"===d||"gml:Point"===d)for(var e=this.parsers[d],f=a.getElementsByTagNameNS(L.XmlUtil.namespaces.gml,d.split(":").pop()),g=0;g<f.length;g++)c.push(e.parse(f[g]));else c=this.parseElement(b,{dimensions:this.dimensions(a)});return c}}),L.GML.LinearRing=L.GML.PointSequence.extend({initialize:function(){L.GML.PointSequence.prototype.initialize.call(this),this.elementTag="gml:LinearRing"},parse:function(a){var b=L.GML.PointSequence.prototype.parse.call(this,a);return b.pop(),b}}),L.GML.CoordsToLatLngMixin={transform:function(a,b){if(Array.isArray(a[0])){for(var c=[],d=0;d<a.length;d++)c.push(this.transform(a[d],b));return c}return b.coordsToLatLng(a)}},L.GML.Point=L.GML.PointNode.extend({includes:L.GML.CoordsToLatLngMixin,parse:function(a,b){var c=L.GML.PointNode.prototype.parse.call(this,a),d=new L.Marker;return d.setLatLng(this.transform(c,b)),d}}),L.GML.LineString=L.GML.PointSequence.extend({includes:L.GML.CoordsToLatLngMixin,initialize:function(){this.elementTag="gml:LineString",L.GML.PointSequence.prototype.initialize.call(this)},parse:function(a,b){var c=new L.Polyline([]),d=L.GML.PointSequence.prototype.parse.call(this,a),e=this.transform(d,b);return c.setLatLngs(e)}}),L.GML.Polygon=L.GML.Geometry.extend({includes:L.GML.CoordsToLatLngMixin,initialize:function(){this.elementTag="gml:Polygon",this.linearRingParser=new L.GML.LinearRing},getCoordinates:function(a){for(var c=[],d=0;d<a.childNodes.length;d++){var e=a.childNodes[d];e.nodeType===b.ELEMENT_NODE&&c.push(this.linearRingParser.parse(e.firstChild))}return c},parse:function(a,b){var c=new L.Polygon([]),d=this.getCoordinates(a);return c.setLatLngs(this.transform(d,b)),c}}),L.GML.MultiGeometry=L.GML.Geometry.extend({includes:L.GML.ParserContainerMixin,initialize:function(){this.initializeParserContainer()},parse:function(a,c){for(var d=[],e=0;e<a.childNodes.length;e++){var f=a.childNodes[e];if(f.nodeType===b.ELEMENT_NODE)for(var g=0;g<f.childNodes.length;g++){var h=f.childNodes[g];h.nodeType===b.ELEMENT_NODE&&d.push(this.parseElement(h,c))}}return d}}),L.GML.AbstractMultiPolyline=L.GML.MultiGeometry.extend({parse:function(a,b){for(var c=L.GML.MultiGeometry.prototype.parse.call(this,a,b),d=new L.MultiPolyline([]),e=0;e<c.length;e++)d.addLayer(c[e]);return d}}),L.GML.AbstractMultiPolygon=L.GML.MultiGeometry.extend({parse:function(a,b){for(var c=L.GML.MultiGeometry.prototype.parse.call(this,a,b),d=new L.MultiPolygon([]),e=0;e<c.length;e++)d.addLayer(c[e]);return d}}),L.GML.MultiLineString=L.GML.AbstractMultiPolyline.extend({initialize:function(){L.GML.AbstractMultiPolyline.prototype.initialize.call(this),this.appendParser(new L.GML.LineString),this.elementTag="gml:MultiLineString"}}),L.GML.MultiCurve=L.GML.AbstractMultiPolyline.extend({initialize:function(){L.GML.AbstractMultiPolyline.prototype.initialize.call(this),this.elementTag="gml:MultiCurve",this.appendParser(new L.GML.LineString)}}),L.GML.MultiPolygon=L.GML.AbstractMultiPolygon.extend({initialize:function(){L.GML.AbstractMultiPolygon.prototype.initialize.call(this),this.elementTag="gml:MultiPolygon",this.appendParser(new L.GML.Polygon)}}),L.GML.MultiSurface=L.GML.AbstractMultiPolygon.extend({initialize:function(){L.GML.AbstractMultiPolygon.prototype.initialize.call(this),this.elementTag="gml:MultiSurface",this.appendParser(new L.GML.Polygon)}}),L.GML.MultiPoint=L.GML.MultiGeometry.extend({initialize:function(){L.GML.MultiGeometry.prototype.initialize.call(this),this.elementTag="gml:MultiPoint",this.appendParser(new L.GML.Point)},parse:function(a,b){var c=L.GML.MultiGeometry.prototype.parse.call(this,a,b);return new L.FeatureGroup(c)}}),L.GML.FeatureType=L.Class.extend({primitives:[{types:["byte","decimal","int","integer","long","short"],parse:function(a){return Number(a)}},{types:["string"],parse:function(a){return a}},{types:["boolean"],parse:function(a){return"false"!==a}},{types:["date","time","datetime"],parse:function(a){return new Date(a)}}],initialize:function(){this.fields={}},appendField:function(a,b){var c=this;this.primitives.forEach(function(d){-1!==d.types.indexOf(b)&&(c.fields[a]=d.parse)})},parse:function(a){for(var c={},d=0;d<a.childNodes.length;d++){var e=a.childNodes[d];if(e.nodeType===b.ELEMENT_NODE){var f=e.tagName.split(":").pop(),g=this.fields[f];g&&(c[f]=g(e.textContent))}}return{properties:c,id:a.attributes["gml:id"].value}}}),L.Format.GML=L.Format.Base.extend({includes:L.GML.ParserContainerMixin,initialize:function(a){L.Format.Base.prototype.initialize.call(this,a),this.outputFormat="text/xml; subtype=gml/3.1.1",this.initializeParserContainer(),this.appendParser(new L.GML.Point),this.appendParser(new L.GML.LineString),this.appendParser(new L.GML.Polygon),this.appendParser(new L.GML.MultiLineString),this.appendParser(new L.GML.MultiPolygon),this.appendParser(new L.GML.MultiCurve),this.appendParser(new L.GML.MultiSurface),this.appendParser(new L.GML.MultiPoint)},responseToLayers:function(a){for(var c=[],d=L.XmlUtil.parseXml(a),e=d.documentElement,f=e.getElementsByTagNameNS(L.XmlUtil.namespaces.gml,"featureMember"),g=0;g<f.length;g++){var h=f[g].firstChild;c.push(this.processFeature(h))}var i=e.getElementsByTagNameNS(L.XmlUtil.namespaces.gml,"featureMembers");if(i.length>0)for(var j=i[0].childNodes,k=0;k<j.length;k++){var l=j[k];l.nodeType===b.ELEMENT_NODE&&c.push(this.processFeature(l))}return c},processFeature:function(a){var b=this.generateLayer(a);return this.layerEvents(b),b.feature=this.featureType.parse(a),b},generateLayer:function(a){var b=a.getElementsByTagNameNS(this.namespaceUri,this.options.geometryField)[0];return this.parseElement(b.firstChild,this.options)}}),L.Util.project=function(a,b){if(L.Util.isArray(b)){var c=[];return b.forEach(function(b){c.push(a.projection.project(b))}),c}return a.projection.project(b)},L.GMLUtil={posNode:function(a){return L.XmlUtil.createElementNS("gml:pos",{srsDimension:2},{value:a.x+" "+a.y})},posListNode:function(a,b){var c=[];if(a.forEach(function(a){c.push(a.x+" "+a.y)}),b&&a.length>0){var d=a[0];c.push(d.x+" "+d.y)}var e=c.join(" ");return L.XmlUtil.createElementNS("gml:posList",{},{value:e})}},L.Marker.include({toGml:function(a){var b=L.XmlUtil.createElementNS("gml:Point",{srsName:a.code});return b.appendChild(L.GMLUtil.posNode(L.Util.project(a,this.getLatLng()))),b}}),L.MultiPolygon.include({toGml:function(a){var b=L.XmlUtil.createElementNS("gml:MultiPolygon",{srsName:a.code,srsDimension:2}),c=b.appendChild(L.XmlUtil.createElementNS("gml:polygonMembers"));return this.eachLayer(function(b){c.appendChild(b.toGml(a))}),b}}),L.MultiPolyline.include({toGml:function(a){var b=L.XmlUtil.createElementNS("gml:MultiLineString",{srsName:a.code,srsDimension:2}),c=b.appendChild(L.XmlUtil.createElementNS("gml:lineStringMembers"));return this.eachLayer(function(b){c.appendChild(b.toGml(a))}),b}}),L.Polygon.include({toGml:function(a){var b=L.XmlUtil.createElementNS("gml:Polygon",{srsName:a.code,srsDimension:2});if(b.appendChild(L.XmlUtil.createElementNS("gml:exterior")).appendChild(L.XmlUtil.createElementNS("gml:LinearRing",{srsDimension:2})).appendChild(L.GMLUtil.posListNode(L.Util.project(a,this.getLatLngs()),!0)),this._holes&&this._holes.length)for(var c in this._holes)b.appendChild(L.XmlUtil.createElementNS("gml:interior")).appendChild(L.XmlUtil.createElementNS("gml:LinearRing",{srsDimension:2})).appendChild(L.GMLUtil.posListNode(L.Util.project(a,this._holes[c]),!0));return b}}),L.Polyline.include({toGml:function(a){var b=L.XmlUtil.createElementNS("gml:LineString",{srsName:a.code,srsDimension:2});return b.appendChild(L.GMLUtil.posListNode(L.Util.project(a,this.getLatLngs()),!1)),b}}),L.WFS=L.FeatureGroup.extend({options:{crs:L.CRS.EPSG3857,showExisting:!0,geometryField:"Shape",url:"",version:"1.1.0",typeNS:"",typeName:"",typeNSName:"",style:{color:"black",weight:1},namespaceUri:""},state:{},initialize:function(a,b){L.setOptions(this,a),this.state={exist:"exist"},this._layers={},this.readFormat=b||new L.Format.GML({crs:this.options.crs,geometryField:this.options.geometryField}),this.options.typeNSName=this.namespaceName(this.options.typeName),this.options.srsName=this.options.crs.code;var c=this;this.describeFeatureType(function(){c.options.showExisting&&c.loadFeatures()})},namespaceName:function(a){return this.options.typeNS+":"+a},describeFeatureType:function(a){var b=L.XmlUtil.createElementNS("wfs:DescribeFeatureType",{service:"WFS",version:this.options.version});b.appendChild(L.XmlUtil.createElementNS("TypeName",{},{value:this.options.typeNSName}));var c=this;L.Util.request({url:this.options.url,data:L.XmlUtil.serializeXmlDocumentString(b),success:function(b){var d=L.XmlUtil.parseXml(b),e=d.documentElement;c.readFormat.setFeatureDescription(e),c.options.namespaceUri=e.attributes.targetNamespace.value,"function"==typeof a&&a()}})},getFeature:function(a){var b=L.XmlUtil.createElementNS("wfs:GetFeature",{service:"WFS",version:this.options.version,outputFormat:this.readFormat.outputFormat}),c=b.appendChild(L.XmlUtil.createElementNS("wfs:Query",{typeName:this.options.typeNSName,srsName:this.options.srsName}));return a&&a.toGml&&c.appendChild(a.toGml()),b},loadFeatures:function(a){var b=this;L.Util.request({url:this.options.url,data:L.XmlUtil.serializeXmlDocumentString(b.getFeature(a)),success:function(a){var c=b.readFormat.responseToLayers(a,{coordsToLatLng:b.options.coordsToLatLng,pointToLayer:b.options.pointToLayer});return c.forEach(function(a){a.state=b.state.exist,b.addLayer(a)}),b.setStyle(b.options.style),b.fire("load"),b}})}}),L.wfs=function(a,b){return new L.WFS(a,b)},L.WFST=L.WFS.extend({initialize:function(a,b){L.WFS.prototype.initialize.call(this,a,b),this.state=L.extend(this.state,{insert:"insert",update:"update",remove:"remove"}),this.changes={}},addLayer:function(a){if(L.FeatureGroup.prototype.addLayer.call(this,a),a.feature||(a.feature={properties:{}}),!a.state){a.state=this.state.insert;var b=this.getLayerId(a);this.changes[b]=a}return this},removeLayer:function(a){L.FeatureGroup.prototype.removeLayer.call(this,a);var b=this.getLayerId(a);if(b in this.changes){var c=this.changes[b];c.state===this.state.insert?delete this.changes[b]:c.state=this.state.remove}else a.state=this.state.remove,this.changes[b]=a},editLayer:function(a){a.state!==this.state.insert&&(a.state=this.state.update);var b=this.getLayerId(a);return this.changes[b]=a,this},save:function(){var a=L.XmlUtil.createElementNS("wfs:Transaction",{service:"WFS",version:this.options.version}),b=[];for(var c in this.changes){var d=this.changes[c],e=this[d.state](d);a.appendChild(e),d.state===this.state.insert&&b.push(d)}var f=this;return L.Util.request({url:this.options.url,data:L.XmlUtil.serializeXmlDocumentString(a),success:function(a){for(var c=L.XmlUtil.evaluate("//wfs:InsertResults/wfs:Feature/ogc:FeatureId/@fid",a),d=new L.Filter.GmlObjectID,e=c.iterateNext();e;)d.append(e.value),e=c.iterateNext();b.forEach(function(a){L.FeatureGroup.prototype.removeLayer.call(f,a)}),f.once("load",function(){f.fire("save:success"),f.changes={}}),f.loadFeatures(d)},error:function(a){f.fire("save:failed",a)}}),this}}),L.wfst=function(a,b){return new L.WFST(a,b)},L.WFST.include({gmlFeature:function(a){var b=L.XmlUtil.createElementNS(this.options.typeNSName,{},{uri:this.options.namespaceUri}),c=a.feature;for(var d in c.properties)b.appendChild(this.gmlProperty(d,c.properties[d]));return b.appendChild(this.gmlProperty(this.options.geometryField,a.toGml(this.options.crs))),b},gmlProperty:function(a,b){var c=L.XmlUtil.createElementNS(this.namespaceName(a));return b instanceof Element?c.appendChild(b):c.appendChild(L.XmlUtil.createTextNode(b||"")),c},wfsProperty:function(a,b){var c=L.XmlUtil.createElementNS("wfs:Property");c.appendChild(L.XmlUtil.createElementNS("wfs:Name",{},{value:a}));var d=L.XmlUtil.createElementNS("wfs:Value");return b instanceof Element?d.appendChild(b):d.appendChild(L.XmlUtil.createTextNode(b||"")),c.appendChild(d),c}}),L.WFST.include({insert:function(a){var b=L.XmlUtil.createElementNS("wfs:Insert");return b.appendChild(this.gmlFeature(a)),b},update:function(a){var b=L.XmlUtil.createElementNS("wfs:Update",{typeName:this.options.typeNSName}),c=a.feature;for(var d in c.properties)b.appendChild(this.wfsProperty(d,c.properties[d]));b.appendChild(this.wfsProperty(this.namespaceName(this.options.geometryField),a.toGml(this.options.crs)));var e=(new L.Filter.GmlObjectID).append(a.feature.id);return b.appendChild(e.toGml()),b},remove:function(a){var b=L.XmlUtil.createElementNS("wfs:Delete",{typeName:this.options.typeNSName}),c=(new L.Filter.GmlObjectID).append(a.feature.id);return b.appendChild(c.toGml()),b}})}(window,document);